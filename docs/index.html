<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>dromozoa-vecmath</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
</head>
<style>
.markdown-body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 45px;
}
@media (max-width: 767px) {
  .markdown-body {
    padding: 15px;
  }
}
</style>
<body>
<div class="markdown-body">

<h1>dromozoa-vecmath</h1>

<h2>リンク</h2>

<ul>
  <li><a href="https://download.java.net/media/java3d/javadoc/1.5.0/index.html">Java 3D 1.5.0</a></li>
  <li><a href="http://objectclub.jp/download/vecmath1">unofficial Java3D vecmath package</a></li>
  <li><a href="https://eigen.tuxfamily.org/">Eigen</a>
    <ul>
      <li><a href="https://eigen.tuxfamily.org/dox/classEigen_1_1JacobiSVD.html">JacobiSVD</a></li>
      <li><a href="https://eigen.tuxfamily.org/dox/classEigen_1_1BDCSVD.html">BDCSVD</a></li>
    </ul>
  </li>
  <li><a href="https://www.cs.utexas.edu/users/inderjit/public_papers/HLA_SVD.pdf">Computation of the Singular Value Decomposition</a></li>
  <li><a href="https://www.irisa.fr/sage/bernard/publis/SVD-Chapter06.pdf">Parallel Algorithms for the Singular Value Decomposition</a></li>
  <li><a href="https://web.stanford.edu/class/cme335/lecture7.pdf">CME 335 - Advanced Topics in Numerical Linear Algebra - Lecture 7</a></li>
  <li><a href="http://nalab.mind.meiji.ac.jp/~mk/labo/text/eigenvalues-add.pdf">固有値問題ノートの補足</a></li>
</ul>

<h2>\(3 \times 3\)行列の特異値分解</h2>

<p>
\(3 \times 3\)行列なので固有方程式を解けば求まる。
ここではヤコビ法を用いて計算する。
</p>

<h3>固有値と特異値の関係</h3>

<p>
行列\(m\)が与えられたとき、\(M = m m^*\)を固有値分解してユニタリ行列\(U\)と固有値行列\(S\)を得る。
\[
  (U, S) = \mathrm{eig}(M)
\]
\(m\)を特異値分解する。
\[\begin{eqnarray}
  m   &amp;=&amp; u s v^* \\
  u   &amp;=&amp; U \\
  s   &amp;=&amp; \sqrt{S} \\
  v^* &amp;=&amp; s^{-1} U^* m
\end{eqnarray}\]
\(3 \times 3\)行列の正規化を実装するために、回転成分\(u v^*\)を計算したい。
回転成分\(u v^*\)は
\[
  u v^* = U s^{-1} U^* m
\]
で表される。
ランクが1または2である場合、0除算が発生するので別の計算式を使う必要がある。
そこでTwo-Sieded Jacovi SVDと呼ばれる手法を用いる。
</p>

<h3>ヤコビ法による固有値分解</h3>

<p>
対称行列\(n\)が与えられたとき、適当な\(p,q\)を選んで収束計算を行う。
\[
  \begin{pmatrix}
    \cos\theta &amp; -\sin\theta \\
    \sin\theta &amp;  \cos\theta
  \end{pmatrix}
  \begin{pmatrix}
    n_{pp} &amp; n_{pq} \\
    n_{pq} &amp; n_{qq}
  \end{pmatrix}
  \begin{pmatrix}
     \cos\theta &amp; \sin\theta \\
    -\sin\theta &amp; \cos\theta
  \end{pmatrix}
  =
  \begin{pmatrix}
    s_p &amp;   0 \\
      0 &amp; s_q
  \end{pmatrix}
\]
</p>

<h3>ヤコビ法による特異値分解</h3>

<p>
適当な\(p,q\)を選び、収束計算を行う。
\[
  \begin{pmatrix}
    \cos\theta &amp; -\sin\theta \\
    \sin\theta &amp;  \cos\theta
  \end{pmatrix}
  \begin{pmatrix}
    m_{pp} &amp; m_{pq} \\
    m_{qp} &amp; m_{qq}
  \end{pmatrix}
  \begin{pmatrix}
     \cos\phi &amp; \sin\phi \\
    -\sin\phi &amp; \cos\phi
  \end{pmatrix}
  \begin{pmatrix}
     \cos\theta &amp; \sin\theta \\
    -\sin\theta &amp; \cos\theta
  \end{pmatrix}
  =
  \begin{pmatrix}
    s_p &amp;   0 \\
      0 &amp; s_q
  \end{pmatrix}
\]
\(\phi\)は
\[
  \begin{pmatrix}
    m_{pp} &amp; m_{pq} \\
    m_{qp} &amp; m_{qp}
  \end{pmatrix}
  \begin{pmatrix}
     \cos\phi &amp; \sin\phi \\
    -\sin\phi &amp; \cos\phi
  \end{pmatrix}
  =
  \begin{pmatrix}
    n_{pp} &amp; n_{pq} \\
    n_{pq} &amp; n_{qq}
  \end{pmatrix}
\]
を満たす回転で、
対称行列でなければならないというヤコビ法の制約を満足させる。
</p>

<h4>収束計算</h4>

<p>
ギブンス変換\(G\)を用いると、\(n\)回めまでの計算は
\[
  (G_{\theta_n}^T \dots G_{\theta_1}^T)
  m
  (G_{\phi_1} G_{\theta_1} \dots G_{\phi_n} G_{\theta_n})
  = S_n
\]
\(S_n\)の非対角成分の2乗和が閾値を下まわったら、収束したと見なす。
</p>
\[
  m =
  (G_{\theta_1} \dots G_{\theta_n})
  S_n
  (G_{\theta_n}^T G_{\phi_n}^T \dots G_{\theta_1}^T G_{\phi_1}^T)
\]
なので
\[\begin{eqnarray}
  u_n     &amp;=&amp; G_{\theta_1} \dots G_{\theta_n} \\
  u_0     &amp;=&amp; I \\
  u_{i+1} &amp;=&amp; u_i G_{\theta_i} \\
  v^*     &amp;=&amp; G_{\theta_n}^T G_{\phi_n}^T \dots G_{\theta_1}^T G_{\phi_1}^T \\
  v       &amp;=&amp; G_{\phi_1} G_{\theta_1} \dots G_{\phi_n} G_{\theta_n} \\
  v_0     &amp;=&amp; I \\
  v_{i+1} &amp;=&amp; v_i G_{\phi_i} G_{\theta_i}
\end{eqnarray}\]
</p>

<p>
特異値が負になった場合、\(s\)の対角要素の符号を反転するように回転する\(J\)を用いて
\[\begin{eqnarray}
  s' &amp;=&amp; s J \\
  v' &amp;=&amp; v J
\end{eqnarray}\]
</p>

<h3>計算例</h3>

<p>
\(p,q,i=1,2,3\)の場合を考える。
</p>

<h4>\(\phi\)の計算</h4>

<p>
\[\begin{eqnarray}
  \begin{pmatrix}
    n_{pp} &amp; n_{pq} &amp; n_{pi} \\
    n_{pq} &amp; n_{qq} &amp; n_{qi} \\
    n_{ip} &amp; n_{iq} &amp; n_{ii}
  \end{pmatrix}
  &amp;=&amp;
  \begin{pmatrix}
    m_{pp} &amp; m_{pq} &amp; m_{pi} \\
    m_{qp} &amp; m_{qq} &amp; m_{qi} \\
    m_{ip} &amp; m_{iq} &amp; m_{ii}
  \end{pmatrix}
  \begin{pmatrix}
     \cos\phi &amp; \sin\phi &amp; 0 \\
    -\sin\phi &amp; \cos\phi &amp; 0 \\
     0        &amp; 0        &amp; 1
  \end{pmatrix} \\
  &amp;=&amp;
  \begin{pmatrix}
    m_{pp} \cos\phi - m_{pq} \sin\phi &amp; m_{pq} \cos\phi + m_{pp} \sin\phi &amp; m_{pi} \\
    m_{qp} \cos\phi - m_{qq} \sin\phi &amp; m_{qq} \cos\phi + m_{qp} \sin\phi &amp; m_{qi} \\
    m_{ip} \cos\phi - m_{iq} \sin\phi &amp; m_{iq} \cos\phi + m_{ip} \sin\phi &amp; m_{ii}
  \end{pmatrix}
\end{eqnarray}\]
\(\phi\)は
\[
  m_{pq} \cos\phi + m_{pp} \sin\phi = m_{qp} \cos\phi - m_{qq} \sin\phi
\]
を満たすので
\[\begin{eqnarray}
  (m_{qp} - m_{pq}) \cos\phi &amp;=&amp; (m_{pp} + m_{qq}) \sin\phi \\
  \cot\phi &amp;=&amp; \frac{m_{pp} + m_{qq}}{m_{qp} - m_{pq}}
\end{eqnarray}\]
\(m_{qp} = m_{pq}\)の場合は、そもそも回転する必要がない（\(\phi = 0\)）。
また、
\[\begin{eqnarray}
  \sin\phi
  &amp;=&amp; \frac{1}{\sqrt{1 + \cot^2\phi}} \\
  &amp;=&amp; \frac{m_{qp} - m_{pq}}{\sqrt{(m_{qp} - m_{pq})^2 + (m_{pp} + m_{qq})^2}} \\
  \cos\phi
  &amp;=&amp; \sin\phi \cot\phi \\
  &amp;=&amp; \frac{m_{pp} + m_{qq}}{\sqrt{(m_{qp} - m_{pq})^2 + (m_{pp} + m_{qq})^2}}
\end{eqnarray}\]
実装では、後述のように三角関数の公式を用いる。
</p>

<h4>\(\theta\)の計算</h4>

<p>
次に
\[\begin{eqnarray}
  \begin{pmatrix}
    m_{pp}' &amp; 0       &amp; m_{pi}' \\
    0       &amp; m_{qq}' &amp; m_{qi}' \\
    m_{ip}' &amp; m_{iq}' &amp; m_{ii}
  \end{pmatrix}
  &amp;=&amp;
  \begin{pmatrix}
    \cos\theta &amp; -\sin\theta &amp; 0 \\
    \sin\theta &amp;  \cos\theta &amp; 0 \\
    0          &amp;  0          &amp; 1
  \end{pmatrix}
  \begin{pmatrix}
    n_{pp} &amp; n_{pq} &amp; n_{pi} \\
    n_{pq} &amp; n_{qq} &amp; n_{qi} \\
    n_{ip} &amp; n_{iq} &amp; n_{ii}
  \end{pmatrix}
  \begin{pmatrix}
     \cos\theta &amp; \sin\theta &amp; 0 \\
    -\sin\theta &amp; \cos\theta &amp; 0 \\
     0          &amp; 0          &amp; 1
  \end{pmatrix} \\
  &amp;=&amp;
  \begin{pmatrix}
    \cos\theta &amp; -\sin\theta &amp; 0 \\
    \sin\theta &amp;  \cos\theta &amp; 0 \\
    0          &amp;  0          &amp; 1
  \end{pmatrix}
  \begin{pmatrix}
    n_{pp} \cos\theta - n_{pq} \sin\theta &amp; n_{pq} \cos\theta + n_{pp} \sin\theta &amp; n_{pi} \\
    n_{pq} \cos\theta - n_{qq} \sin\theta &amp; n_{qq} \cos\theta + n_{pq} \sin\theta &amp; n_{qi} \\
    n_{ip} \cos\theta - n_{iq} \sin\theta &amp; n_{iq} \cos\theta + n_{ip} \sin\theta &amp; n_{ii}
  \end{pmatrix} \\
  &amp;=&amp;
  \begin{pmatrix}
    n_{pp} \cos^2\theta - 2 n_{pq} \cos\theta \sin\theta + n_{qq} \sin^2\theta &amp;
    (n_{pp} - n_{qq}) \cos\theta \sin\theta + n_{pq} (\cos^2\theta - \sin^2\theta) &amp;
    n_{pi} \cos\theta - n_{qi} \sin\theta \\
    (n_{pp} - n_{qq}) \cos\theta \sin\theta + n_{pq} (\cos^2\theta - \sin^2\theta) &amp;
    n_{pp} \sin^2\theta + 2 n_{pq} \cos\theta \sin\theta + n_{qq} \cos^2\theta &amp;
    n_{qi} \cos\theta + n_{pi} \sin\theta \\
    n_{ip} \cos\theta - n_{iq} \sin\theta &amp;
    n_{iq} \cos\theta + n_{ip} \sin\theta &amp;
    n_{ii}
  \end{pmatrix}
\end{eqnarray}\]
\(\theta\)は
\[
  (n_{pp} - n_{qq}) \cos\theta \sin\theta + n_{pq} (\cos^2\theta - \sin^2\theta) = 0
\]
を満たすので、倍角の公式を用いて
\[\begin{eqnarray}
  n_{pq} \cos 2\theta &amp;=&amp; \frac{n_{qq} - n_{pp}}{2} \sin 2\theta \\
  \cot 2\theta &amp;=&amp; \frac{n_{qq} - n_{pp}}{2 n_{pq}}
\end{eqnarray}\]
</p>

<h4>三角関数の公式</h4>

<p>
RutishauserはThe Jacobi Method for Real Symmetric Matricesで
\[\begin{eqnarray}
  \tan\theta &amp;=&amp; \frac{\mathrm{sign}(\cot 2\theta)}{|\cot 2\theta| + \sqrt{1 + \cot^2 2\theta}} \\
  \cos\theta &amp;=&amp; \frac{1}{\sqrt{1 + tan^2 \theta}} \\
  \sin\theta &amp;=&amp; \cos\theta \tan\theta \\
  \tan\frac{\theta}{2} &amp;=&amp; \frac{\sin\theta}{1 + \cos\theta} \\
  a \cos\theta - b \sin\theta &amp;=&amp; a - (b + a \tan\frac{\theta}{2}) \sin\theta \\
  a \cos\theta + b \sin\theta &amp;=&amp; a + (b - a \tan\frac{\theta}{2}) \sin\theta
\end{eqnarray}\]
を用いて
\[\begin{eqnarray}
  m_{pp}' &amp;=&amp; n_{pp} - n_{pq} \tan\theta \\
  m_{qq}' &amp;=&amp; n_{qq} + n_{pq} \tan\theta \\
  m_{pi}' &amp;=&amp; n_{pi} - (n_{qi} +  n_{pi} \tan\frac{\theta}{2}) \sin\theta \\
  m_{qi}' &amp;=&amp; n_{qi} + (n_{pi} -  n_{qi} \tan\frac{\theta}{2}) \sin\theta
\end{eqnarray}\]
固有値分解では\(m_{pi}' = m_{ip}', m_{qi}' = m_{iq}'\)なので計算を省略できるが、特異値分解では計算する必要がある。
</p>

<h4>回転成分</h4>

<p>
\[\begin{eqnarray}
  \begin{pmatrix}
    u_{11}' &amp; u_{12}' &amp; u_{13}' \\
    u_{21}' &amp; u_{22}' &amp; u_{23}' \\
    u_{31}' &amp; u_{32}' &amp; u_{33}'
  \end{pmatrix}
  &amp;=&amp;
  \begin{pmatrix}
    u_{11} &amp; u_{12} &amp; u_{13} \\
    u_{21} &amp; u_{22} &amp; u_{23} \\
    u_{31} &amp; u_{32} &amp; u_{33}
  \end{pmatrix}
  \begin{pmatrix}
     \cos\theta &amp; \sin\theta &amp; 0 \\
    -\sin\theta &amp; \cos\theta &amp; 0 \\
     0          &amp; 0          &amp; 1
  \end{pmatrix} \\
  \begin{pmatrix}
    v_{11}' &amp; v_{12}' &amp; v_{13}' \\
    v_{21}' &amp; v_{22}' &amp; v_{23}' \\
    v_{31}' &amp; v_{32}' &amp; v_{33}'
  \end{pmatrix}
  &amp;=&amp;
  \begin{pmatrix}
    v_{11} &amp; v_{12} &amp; v_{13} \\
    v_{21} &amp; v_{22} &amp; v_{23} \\
    v_{31} &amp; v_{32} &amp; v_{33}
  \end{pmatrix}
  \begin{pmatrix}
     \cos\phi &amp; \sin\phi &amp; 0 \\
    -\sin\phi &amp; \cos\phi &amp; 0 \\
     0        &amp; 0        &amp; 1
  \end{pmatrix}
  \begin{pmatrix}
     \cos\theta &amp; \sin\theta &amp; 0 \\
    -\sin\theta &amp; \cos\theta &amp; 0 \\
     0          &amp; 0          &amp; 1
  \end{pmatrix} \\
\end{eqnarray}\]
</p>

<h3>\(p,q,i\)に対応するインデックス</h3>

<table>
  <tr>
    <th>\(p,q,i\)</th>
    <th>pp</th><th>pq</th><th>pi</th>
    <th>qp</th><th>qq</th><th>qi</th>
    <th>ip</th><th>iq</th><th>ii</th>
  </tr>
  <tr>
    <td>\(1,2,3\)</td>
    <td>1</td><td>2</td><td>3</td>
    <td>4</td><td>5</td><td>6</td>
    <td>7</td><td>8</td><td>9</td>
  </tr>
  <tr>
    <td>\(1,3,2\)</td>
    <td>1</td><td>3</td><td>2</td>
    <td>7</td><td>9</td><td>8</td>
    <td>4</td><td>6</td><td>5</td>
  </tr>
  <tr>
    <td>\(2,3,1\)</td>
    <td>5</td><td>6</td><td>4</td>
    <td>8</td><td>9</td><td>7</td>
    <td>2</td><td>3</td><td>1</td>
  </tr>
</table>

<h2>\(3 \times 3\)行列の外積による正規化</h2>

<h3>Sunの実装</h3>

<p>
第1列と第2列を正規化したうえで、外積を計算する。
\[\begin{eqnarray}
  A &amp;=&amp; \begin{pmatrix}
    a_{11} &amp; a_{12} &amp; a_{13} \\
    a_{21} &amp; a_{22} &amp; a_{23} \\
    a_{31} &amp; a_{32} &amp; a_{33}
  \end{pmatrix} \\
  A_1,
  A_2
  &amp;=&amp;
  \begin{pmatrix} a_{11} \\  a_{21} \\ a_{31} \end{pmatrix},
  \begin{pmatrix} a_{12} \\  a_{22} \\ a_{32} \end{pmatrix} \\
  B
  &amp;=&amp; \begin{pmatrix}
    \frac{A_1}{\|A_1\|} &amp;
    \frac{A_2}{\|A_2\|} &amp;
    \frac{A_1}{\|A_1\|} \times \frac{A_2}{\|A_2\|}
  \end{pmatrix} \\
  &amp;=&amp; \begin{pmatrix}
    \frac{a_{11}}{\|A_1\|} &amp; \frac{a_{12}}{\|A_2\|} &amp; \frac{a_{21} a_{32} - a_{22} a_{31}}{\|A_1\| \|A_2\|} \\
    \frac{a_{21}}{\|A_1\|} &amp; \frac{a_{22}}{\|A_2\|} &amp; \frac{a_{31} a_{12} - a_{32} a_{11}}{\|A_1\| \|A_2\|} \\
    \frac{a_{31}}{\|A_1\|} &amp; \frac{a_{32}}{\|A_2\|} &amp; \frac{a_{11} a_{22} - a_{12} a_{21}}{\|A_1\| \|A_2\|}
  \end{pmatrix}
\end{eqnarray}\]
</p>


<h3>平鍋の実装</h3>

<p>
行列式の3乗根をかける。
\[
  B = \sqrt[3]{\mathrm{det}(A)} A
\]
</p>

</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  CommonHTML: {
    undefinedFamily: "sans-serif"
  }
});
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML"></script>
</body>
</html>
